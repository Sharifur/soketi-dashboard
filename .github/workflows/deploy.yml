name: 🚀 Deploy Soketi Dashboard

on:
  push:
    branches: [ production ]

env:
  PHP_VERSION: '8.2'

jobs:
  deploy-production:
    name: 🌟 Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/production' && github.event_name == 'push'
    environment: production

    steps:
      - name: 🚀 Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          password: ${{ secrets.PRODUCTION_PASSWORD }}
          port: ${{ secrets.PRODUCTION_PORT || 22 }}
          script: |
            echo "🌟 Starting Soketi Dashboard deployment to production..."

            # Navigate to application directory
            cd ${{ secrets.PRODUCTION_APP_PATH }}

            # Create backup
            BACKUP_DIR="../backups/$(date +%Y%m%d-%H%M%S)"
            mkdir -p ../backups
            cp -r . "$BACKUP_DIR"
            echo "✅ Backup created at $BACKUP_DIR"

            # Enable maintenance mode
            php artisan down --message="Deploying..." --retry=60

            # Pull latest changes
            git fetch origin
            git reset --hard origin/production
            git clean -fd

            # Install/update PHP dependencies
            composer install --no-dev --optimize-autoloader --no-interaction

            # Install/update NPM dependencies and build assets
            npm ci
            npm run build

            # Clear caches
            php artisan config:clear
            php artisan cache:clear
            php artisan view:clear
            php artisan route:clear

            # Run migrations
            php artisan migrate --force

            # Optimize for production
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Update file permissions
            sudo chown -R www-data:www-data storage bootstrap/cache public/build
            sudo chmod -R 755 storage bootstrap/cache public/build

            # Restart services
            sudo systemctl reload nginx
            sudo systemctl reload php8.2-fpm

            # Simple health check
            sleep 3
            if curl -f -s http://localhost > /dev/null; then
              echo "✅ Health check passed"
            else
              echo "❌ Health check failed"
            fi

            # Disable maintenance mode
            php artisan up

            # Clean old backups (keep last 3)
            cd ../backups
            ls -1t | tail -n +4 | xargs -r rm -rf

            echo "🎉 Production deployment completed!"
